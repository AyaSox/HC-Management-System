@model HRManagementSystem.Models.LeaveApplication

@{
    ViewData["Title"] = "Leave Application Details";
    var currentUser = ViewBag.CurrentUser as HRManagementSystem.Models.Employee;
    var canApprove = Model.Employee.LineManagerId == currentUser?.EmployeeId || User.IsInRole("Admin");
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-alt"></i> Leave Application Details</h2>
    <a href="javascript:history.back()" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back
    </a>
</div>

<!-- Main Details Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-user"></i> @Model.Employee.FullName - @Model.LeaveType.Name
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fas fa-user-tie"></i> Employee</label>
                    <div class="form-control-plaintext">
                        <strong>@Model.Employee.FullName</strong><br>
                        <small class="text-muted">@Model.Employee.JobTitle - @Model.Employee.Department?.Name</small><br>
                        <small class="text-muted">Employee #: @Model.Employee.EmployeeNumber</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fas fa-list"></i> Leave Type</label>
                    <div class="form-control-plaintext">
                        <span class="badge @Model.LeaveType.Color fs-6">@Model.LeaveType.Name</span>
                        @if (!Model.LeaveType.IsPaid)
                        {
                            <span class="badge bg-warning">Unpaid</span>
                        }
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fas fa-calendar-alt"></i> Leave Period</label>
                    <div class="form-control-plaintext">
                        <strong>@Model.StartDate.ToString("dddd, dd MMMM yyyy")</strong><br>
                        <span class="text-muted">to</span><br>
                        <strong>@Model.EndDate.ToString("dddd, dd MMMM yyyy")</strong>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fas fa-clock"></i> Duration</label>
                    <div class="form-control-plaintext">
                        <span class="badge bg-info fs-6">@Model.TotalDays days</span>
                        <small class="text-muted d-block">Weekdays only (excludes weekends)</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fas fa-calendar-plus"></i> Applied Date</label>
                    <div class="form-control-plaintext">
                        @Model.AppliedDate.ToString("dddd, dd MMMM yyyy 'at' HH:mm")
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fas fa-flag"></i> Status</label>
                    <div class="form-control-plaintext">
                        <span class="badge @Model.StatusBadgeClass fs-6">
                            <i class="fas @Model.StatusIcon"></i> @Model.Status
                        </span>
                    </div>
                </div>

                @if (Model.ReviewedBy != null)
                {
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-user-check"></i> Reviewed By</label>
                        <div class="form-control-plaintext">
                            <strong>@Model.ReviewedBy.FullName</strong><br>
                            <small class="text-muted">@Model.ReviewedBy.JobTitle</small><br>
                            <small class="text-muted">@Model.ReviewedDate?.ToString("dd MMM yyyy 'at' HH:mm")</small>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.ContactDuringLeave))
                {
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-phone"></i> Emergency Contact</label>
                        <div class="form-control-plaintext">
                            @Model.ContactDuringLeave
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Reason Card -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-comment"></i> Reason for Leave</h6>
    </div>
    <div class="card-body">
        <p class="mb-0">@Model.Reason</p>
    </div>
</div>

<!-- Supporting Document -->
@if (!string.IsNullOrEmpty(Model.SupportingDocumentPath))
{
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-paperclip"></i> Supporting Document</h6>
        </div>
        <div class="card-body">
            <a href="@Model.SupportingDocumentPath" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-download"></i> Download Document
            </a>
        </div>
    </div>
}

<!-- Review Comments -->
@if (!string.IsNullOrEmpty(Model.ReviewComments))
{
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-comments"></i> Review Comments</h6>
        </div>
        <div class="card-body">
            <p class="mb-0">@Model.ReviewComments</p>
            <small class="text-muted">
                - @Model.ReviewedBy?.FullName, @Model.ReviewedDate?.ToString("dd MMM yyyy")
            </small>
        </div>
    </div>
}

<!-- Actions -->
@if (Model.Status == HRManagementSystem.Models.LeaveStatus.Pending)
{
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-cogs"></i> Actions</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Employee Actions -->
                @if (Model.EmployeeId == currentUser?.EmployeeId)
                {
                    <div class="col-md-6">
                        <h6>Employee Actions</h6>
                        @if (Model.CanBeCancelled)
                        {
                            <form asp-action="Cancel" asp-route-id="@Model.LeaveApplicationId" method="post" class="d-inline" 
                                  onsubmit="return confirm('Are you sure you want to cancel this leave application?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-ban"></i> Cancel Application
                                </button>
                            </form>
                        }
                    </div>
                }
                
                <!-- Manager Actions -->
                @if (canApprove)
                {
                    <div class="col-md-6">
                        <h6>Manager Actions</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <form asp-action="Approve" asp-route-id="@Model.LeaveApplicationId" method="post" class="d-inline" 
                                  onsubmit="return confirm('Are you sure you want to approve this leave application?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="comments" value="Approved via details view" />
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </form>
                            
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- Reject Modal -->
@if (canApprove && Model.Status == HRManagementSystem.Models.LeaveStatus.Pending)
{
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Reject" asp-route-id="@Model.LeaveApplicationId" method="post">
                    @Html.AntiForgeryToken()
                    <div class="modal-header">
                        <h5 class="modal-title" id="rejectModalLabel">
                            <i class="fas fa-times-circle text-danger"></i> Reject Leave Application
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            You are about to reject this leave application. Please provide a reason.
                        </div>
                        
                        <div class="mb-3">
                            <label for="comments" class="form-label">
                                <i class="fas fa-comment"></i> Reason for Rejection <span class="text-danger">*</span>
                            </label>
                            <textarea name="comments" id="comments" class="form-control" rows="4" 
                                      placeholder="Please provide a clear reason for rejecting this leave application..." required></textarea>
                            <div class="form-text">This message will be visible to the employee.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-times-circle"></i> Reject Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<style>
    .fas {
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }
</style>
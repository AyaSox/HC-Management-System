@model IEnumerable<HRManagementSystem.Models.LeaveApplication>

@{
    ViewData["Title"] = "HR Leave Dashboard";
    var pendingCount = ViewBag.PendingCount;
    var approvedCount = ViewBag.ApprovedCount;
    var rejectedCount = ViewBag.RejectedCount;
    var totalCount = Model.Count();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line"></i> HR Leave Management Dashboard</h2>
    <div class="d-flex gap-2">
        <a asp-action="LeaveTypes" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> Leave Types
        </a>
        <div class="dropdown">
            <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-download"></i> Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                    <i class="fas fa-file-excel text-success"></i> Excel Report
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToPdf()">
                    <i class="fas fa-file-pdf text-danger"></i> PDF Report
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToCsv()">
                    <i class="fas fa-file-csv text-warning"></i> CSV Data
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">@pendingCount</h3>
                        <p class="mb-0">Pending</p>
                    </div>
                    <div>
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">@approvedCount</h3>
                        <p class="mb-0">Approved</p>
                    </div>
                    <div>
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">@rejectedCount</h3>
                        <p class="mb-0">Rejected</p>
                    </div>
                    <div>
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">@totalCount</h3>
                        <p class="mb-0">Total</p>
                    </div>
                    <div>
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
    </div>
    <div class="card-body">
        <form method="get" id="filterForm">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Employee</label>
                    <input type="text" name="employee" class="form-control" placeholder="Search employee..." onchange="applyFilters()" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">From Date</label>
                    <input type="date" name="fromDate" class="form-control" onchange="applyFilters()" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Date</label>
                    <input type="date" name="toDate" class="form-control" onchange="applyFilters()" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Leave Applications Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-table"></i> All Leave Applications</h5>
    </div>
    <div class="card-body p-0">
        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="leaveTable">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <a href="#" onclick="sortTable('employee')" class="text-white text-decoration-none">
                                    Employee <i class="fas fa-sort"></i>
                                </a>
                            </th>
                            <th>Department</th>
                            <th>Leave Type</th>
                            <th>
                                <a href="#" onclick="sortTable('period')" class="text-white text-decoration-none">
                                    Period <i class="fas fa-sort"></i>
                                </a>
                            </th>
                            <th>Days</th>
                            <th>
                                <a href="#" onclick="sortTable('applied')" class="text-white text-decoration-none">
                                    Applied <i class="fas fa-sort"></i>
                                </a>
                            </th>
                            <th>
                                <a href="#" onclick="sortTable('status')" class="text-white text-decoration-none">
                                    Status <i class="fas fa-sort"></i>
                                </a>
                            </th>
                            <th>Manager</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var application in Model.OrderByDescending(a => a.AppliedDate))
                        {
                            <tr class="leave-row" 
                                data-status="@application.Status.ToString()"
                                data-employee="@application.Employee.FullName.ToLower()"
                                data-applied="@application.AppliedDate.ToString("yyyy-MM-dd")"
                                data-start="@application.StartDate.ToString("yyyy-MM-dd")">
                                <td>
                                    <div>
                                        <strong>@application.Employee.FullName</strong>
                                        <br>
                                        <small class="text-muted">@application.Employee.EmployeeNumber</small>
                                        <br>
                                        <small class="text-muted">@application.Employee.JobTitle</small>
                                    </div>
                                </td>
                                <td>@application.Employee.Department?.Name</td>
                                <td>
                                    <span class="badge @application.LeaveType.Color">
                                        @application.LeaveType.Name
                                    </span>
                                    @if (!application.LeaveType.IsPaid)
                                    {
                                        <br><small class="badge bg-warning">Unpaid</small>
                                    }
                                </td>
                                <td>
                                    <div>
                                        <strong>@application.StartDate.ToString("dd MMM yyyy")</strong>
                                        <br>
                                        <small class="text-muted">to</small>
                                        <br>
                                        <strong>@application.EndDate.ToString("dd MMM yyyy")</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">@application.TotalDays</span>
                                </td>
                                <td>
                                    @application.AppliedDate.ToString("dd MMM yyyy")
                                    <br>
                                    <small class="text-muted">@application.AppliedDate.ToString("HH:mm")</small>
                                </td>
                                <td>
                                    <span class="badge @application.StatusBadgeClass">
                                        <i class="fas @application.StatusIcon"></i>
                                        @application.Status
                                    </span>
                                    @if (application.ReviewedDate.HasValue)
                                    {
                                        <br>
                                        <small class="text-muted">@application.ReviewedDate.Value.ToString("dd MMM")</small>
                                    }
                                </td>
                                <td>
                                    @if (application.ReviewedBy != null)
                                    {
                                        <div>
                                            @application.ReviewedBy.FullName
                                            <br>
                                            <small class="text-muted">@application.ReviewedBy.JobTitle</small>
                                        </div>
                                    }
                                    else if (application.Employee.LineManager != null)
                                    {
                                        <div class="text-muted">
                                            @application.Employee.LineManager.FullName
                                            <br>
                                            <small>Line Manager</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <a asp-action="Details" asp-route-id="@application.LeaveApplicationId" 
                                           class="btn btn-outline-info" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        @if (application.Status == HRManagementSystem.Models.LeaveStatus.Pending)
                                        {
                                            <div class="btn-group btn-group-sm">
                                                <form asp-action="Approve" asp-route-id="@application.LeaveApplicationId" method="post" class="d-inline" 
                                                      onsubmit="return confirm('Approve this leave application?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="comments" value="HR Override Approval" />
                                                    <button type="submit" class="btn btn-success btn-sm" title="HR Override - Approve">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-danger btn-sm" 
                                                        onclick="showHRRejectModal(@application.LeaveApplicationId, '@application.Employee.FullName')"
                                                        title="HR Override - Reject">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                <h4>No Leave Applications</h4>
                <p class="text-muted">No leave applications found matching the current filters.</p>
            </div>
        }
    </div>
</div>

<!-- HR Reject Modal -->
<div class="modal fade" id="hrRejectModal" tabindex="-1" aria-labelledby="hrRejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Reject" method="post" id="hrRejectForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="hrRejectId" />
                
                <div class="modal-header">
                    <h5 class="modal-title" id="hrRejectModalLabel">
                        <i class="fas fa-user-shield text-danger"></i> HR Override - Reject Leave Application
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>HR Override:</strong> You are about to reject the leave application for <strong id="hrRejectEmployeeName"></strong>.
                        This will override the normal approval process.
                    </div>
                    
                    <div class="mb-3">
                        <label for="hrRejectComments" class="form-label">
                            <i class="fas fa-comment"></i> HR Comments <span class="text-danger">*</span>
                        </label>
                        <textarea name="comments" id="hrRejectComments" class="form-control" rows="4" 
                                  placeholder="Please provide HR comments for this rejection..." required></textarea>
                        <div class="form-text">This message will be visible to the employee and their manager.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-user-shield"></i> HR Reject
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function applyFilters() {
        const status = document.querySelector('select[name="status"]').value.toLowerCase();
        const employee = document.querySelector('input[name="employee"]').value.toLowerCase();
        const fromDate = document.querySelector('input[name="fromDate"]').value;
        const toDate = document.querySelector('input[name="toDate"]').value;
        
        const rows = document.querySelectorAll('.leave-row');
        
        rows.forEach(row => {
            let show = true;
            
            // Status filter
            if (status && !row.dataset.status.toLowerCase().includes(status)) {
                show = false;
            }
            
            // Employee filter
            if (employee && !row.dataset.employee.includes(employee)) {
                show = false;
            }
            
            // Date filters
            if (fromDate && row.dataset.applied < fromDate) {
                show = false;
            }
            
            if (toDate && row.dataset.applied > toDate) {
                show = false;
            }
            
            row.style.display = show ? '' : 'none';
        });
        
        updateVisibleCount();
    }

    function clearFilters() {
        document.getElementById('filterForm').reset();
        document.querySelectorAll('.leave-row').forEach(row => {
            row.style.display = '';
        });
        updateVisibleCount();
    }

    function updateVisibleCount() {
        const visibleRows = document.querySelectorAll('.leave-row[style=""], .leave-row:not([style])').length;
        // Update some counter if needed
    }

    function showHRRejectModal(applicationId, employeeName) {
        document.getElementById('hrRejectId').value = applicationId;
        document.getElementById('hrRejectEmployeeName').textContent = employeeName;
        document.getElementById('hrRejectComments').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('hrRejectModal'));
        modal.show();
    }

    function sortTable(column) {
        // Implement table sorting logic
        console.log('Sorting by:', column);
        // This would typically involve sorting the table rows
    }

    function exportToExcel() {
        alert('Excel export functionality would be implemented here');
    }

    function exportToPdf() {
        alert('PDF export functionality would be implemented here');
    }

    function exportToCsv() {
        alert('CSV export functionality would be implemented here');
    }

    // Auto-refresh every 2 minutes
    setTimeout(function() {
        location.reload();
    }, 120000);
</script>

<style>
    .fas {
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .btn-group-vertical .btn {
        margin-bottom: 2px;
    }
    
    .card-body .row .card {
        transition: transform 0.2s;
    }
    
    .card-body .row .card:hover {
        transform: translateY(-2px);
    }
</style>